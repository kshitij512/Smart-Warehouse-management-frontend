<h2 class="page-title">
  Order Management
</h2>

<p class="role-label">
  Logged in as: <strong>{{ currentRole }}</strong>
</p>

<!-- Toast -->
<div *ngIf="toastMessage" class="toast">
  {{ toastMessage }}
</div>

<!-- Error -->
<div *ngIf="error" class="error-banner">
  {{ error }}
  <button class="btn-red small" (click)="error = null">✖</button>
</div>

<!-- ================= CREATE ORDER ================= -->

<div *ngIf="canCreateOrder" class="card">

  <h3>Create Order</h3>

  <form [formGroup]="form"
        (ngSubmit)="createOrder()"
        class="form-grid">

    <select formControlName="warehouseId">
      <option [ngValue]="null">Select Warehouse</option>
      <option *ngFor="let w of warehouses" [ngValue]="w.id">
        {{ w.name }}
      </option>
    </select>

    <input placeholder="Customer Name" formControlName="customerName" />
    <input placeholder="Customer Email" formControlName="customerEmail" />
    <input placeholder="Customer Address" formControlName="customerAddress" />
    <input placeholder="Customer Phone" formControlName="customerPhone" />

    <div class="full-width">
      <h4>Products</h4>

      <div formArrayName="items">

        <div *ngFor="let item of items.controls; let i = index"
             [formGroupName]="i"
             class="product-row">

          <select formControlName="productId">
            <option [ngValue]="null">Select Product</option>
            <option *ngFor="let p of products" [ngValue]="p.id">
              {{ p.name }} ({{ p.price }})
            </option>
          </select>

          <input type="number" formControlName="quantity" />

          <button type="button"
                  class="btn-red small"
                  (click)="removeItem(i)">
            Remove
          </button>

        </div>

      </div>

      <button type="button"
              class="btn-yellow small"
              (click)="addItem()">
        Add Product
      </button>

    </div>

    <button class="btn-yellow"
            type="submit"
            [disabled]="form.invalid || loading">
      Create Order
    </button>

  </form>

</div>

<!-- ================= ORDER LIST ================= -->

<div class="card">

  <h3>Orders</h3>

  <!-- FILTER BAR -->
  <div class="warehouse-selector">

    <!-- Warehouse Filter -->
    <select *ngIf="!isStaff"
            [(ngModel)]="selectedWarehouseId"
            (ngModelChange)="updateFilters()">

      <option [ngValue]="null">Select Warehouse</option>
      <option *ngFor="let w of warehouses" [ngValue]="w.id">
        {{ w.name }}
      </option>

    </select>

    <!-- Status Filter -->
    <select [(ngModel)]="selectedStatus"
            (ngModelChange)="updateFilters()">

      <option [ngValue]="null">All Status</option>

      <option *ngFor="let s of orderStatuses"
              [ngValue]="s">
        {{ s }}
      </option>

    </select>

  </div>

  <!-- ================= TABLE ================= -->

  <table *ngIf="orders.length > 0">

    <tr>
      <th>ID</th>
      <th>Customer</th>
      <th>Total</th>
      <th>Status</th>
      <th>Assigned</th>
      <th>Actions</th>
    </tr>

    <tr *ngFor="let order of orders">

      <td>{{ order.id }}</td>
      <td>{{ order.customerName }}</td>
      <td>{{ order.totalAmount }}</td>

      <!-- STATUS COLUMN -->
      <td>

        <!-- Status Badge -->
        <span class="status"
              [ngClass]="order.status.toLowerCase()">
          {{ order.status }}
        </span>

        <!-- Status Dropdown -->
        <select
          *ngIf="canUpdateStatus && order.allowedTransitions.length > 0"
          [ngModel]="null"
          (ngModelChange)="updateStatus(order, $event)">

          <option [ngValue]="null" disabled>
            Change Status
          </option>

          <option *ngFor="let s of order.allowedTransitions"
                  [ngValue]="s">
            {{ s }}
          </option>

        </select>

      </td>

      <!-- ASSIGNED STAFF -->
      <td>
        {{ order.assignedStaffName || '—' }}
      </td>

      <!-- ACTIONS -->
      <td class="action-buttons">

        <!-- ASSIGN STAFF -->
        <div *ngIf="canAssignStaff" class="assign-row">

          <select [(ngModel)]="order._selectedStaffId">
            <option [ngValue]="null">Assign Staff</option>
            <option *ngFor="let s of staffUsers" [ngValue]="s.id">
              {{ s.name }}
            </option>
          </select>

          <button class="btn-yellow small"
                  (click)="assignStaff(order)"
                  [disabled]="!order._selectedStaffId">
            Assign
          </button>

        </div>

        <!-- TRACKING -->
        <button class="btn-red small"
                (click)="viewTracking(order.id)">
          Tracking
        </button>

      </td>

    </tr>

  </table>

  <div *ngIf="orders.length === 0">
    No orders found.
  </div>

</div>

<!-- ================= TRACKING MODAL ================= -->

<div *ngIf="showTrackingModal" class="modal-backdrop">
  <div class="modal card tracking-modal">

    <h3>Order Tracking</h3>

    <div class="timeline">

      <div *ngFor="let step of orderStatuses"
           class="timeline-step"
           [ngClass]="getStepClass(step)">

        <div class="circle"></div>

        <div class="content">
          <strong>{{ step }}</strong>

          <div class="timestamp" *ngIf="getTimestamp(step)">
            {{ getTimestamp(step) | date:'medium' }}
          </div>

        </div>

      </div>

    </div>

    <button class="btn-red"
            (click)="closeTracking()">
      Close
    </button>

  </div>
</div>
