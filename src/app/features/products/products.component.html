<h2 class="page-title">
  Product Management
</h2>

<!-- Toast -->
<div *ngIf="toastMessage" class="toast">
  {{ toastMessage }}
</div>

<!-- Error Banner -->
<div *ngIf="error" class="error-banner">
  <span>{{ error }}</span>
  <button class="btn-red small" (click)="error = null">âœ–</button>
</div>

<!-- ===================== CREATE / EDIT FORM ===================== -->

<div class="card">

  <h3>
    {{ editMode ? 'Edit Product' : 'Create Product' }}
  </h3>

  <form [formGroup]="form"
        (ngSubmit)="submit()"
        class="form-grid">

    <!-- SKU -->
    <div>
      <input
        placeholder="SKU"
        formControlName="sku"
        [readonly]="editMode"
      />

      <!-- Required Error -->
      <div class="validation-error"
           *ngIf="form.get('sku')?.touched && form.get('sku')?.hasError('required')">
        SKU is required
      </div>

      <!-- Async SKU Taken Error -->
      <div class="validation-error"
           *ngIf="form.get('sku')?.hasError('skuTaken')">
        SKU already exists
      </div>

      <!-- Checking Indicator -->
      <div class="validation-hint"
           *ngIf="form.get('sku')?.pending">
        Checking SKU availability...
      </div>
    </div>

    <!-- NAME -->
    <div>
      <input
        placeholder="Product Name"
        formControlName="name"
      />

      <div class="validation-error"
           *ngIf="form.get('name')?.touched && form.get('name')?.hasError('required')">
        Product name is required
      </div>
    </div>

    <!-- PRICE -->
    <div>
      <input
        type="number"
        step="0.01"
        placeholder="Price"
        formControlName="price"
      />

      <div class="validation-error"
           *ngIf="form.get('price')?.touched && form.get('price')?.hasError('required')">
        Price is required
      </div>

      <div class="validation-error"
           *ngIf="form.get('price')?.hasError('min')">
        Price must be greater than 0
      </div>
    </div>

    <!-- SUBMIT BUTTON -->
    <button class="btn-yellow"
            type="submit"
            [disabled]="form.invalid || form.pending || loading">
      {{ editMode ? 'Update' : 'Create' }}
    </button>

  </form>

</div>

<!-- ===================== SEARCH ===================== -->

<div class="card">

  <h3>Product List</h3>

  <div class="search-row">

    <input
      placeholder="Search by name or SKU"
      [(ngModel)]="searchTerm"
    />

    <button class="btn-yellow"
            (click)="applySearch()">
      Search
    </button>

    <button class="btn-red"
            (click)="loadProducts()">
      Reset
    </button>

  </div>

</div>

<!-- ===================== TABLE ===================== -->

<table *ngIf="filteredProducts.length > 0">

  <tr>
    <th (click)="sort('sku')">SKU</th>
    <th (click)="sort('name')">Name</th>
    <th (click)="sort('price')">Price</th>
    <th (click)="sort('createdAt')">Created At</th>
    <th>Actions</th>
  </tr>

  <tr *ngFor="let p of paginatedProducts">

    <td>{{ p.sku }}</td>
    <td>{{ p.name }}</td>
    <td>{{ p.price }}</td>
    <td>{{ p.createdAt | date:'short' }}</td>

    <td class="action-buttons">

      <button class="btn-yellow small"
              (click)="editProduct(p)">
        Edit
      </button>

      <button class="btn-red small"
              (click)="confirmDelete(p.id)">
        Delete
      </button>

    </td>

  </tr>

</table>

<div *ngIf="!loading && filteredProducts.length === 0">
  No products found.
</div>

<!-- ===================== PAGINATION ===================== -->

<div class="pagination"
     *ngIf="filteredProducts.length > pageSize">

  <button class="btn-yellow small"
          (click)="currentPage = currentPage - 1"
          [disabled]="currentPage === 1">
    Previous
  </button>

  <span>Page {{ currentPage }}</span>

  <button class="btn-yellow small"
          (click)="currentPage = currentPage + 1"
          [disabled]="currentPage * pageSize >= filteredProducts.length">
    Next
  </button>

</div>

<!-- ===================== DELETE CONFIRM MODAL ===================== -->

<div *ngIf="showConfirmModal" class="modal-backdrop">
  <div class="modal card">

    <p>Are you sure you want to delete this product?</p>

    <div class="modal-actions">

      <button class="btn-red"
              (click)="deleteProduct()">
        Yes
      </button>

      <button class="btn-yellow"
              (click)="cancelDelete()">
        Cancel
      </button>

    </div>

  </div>
</div>
